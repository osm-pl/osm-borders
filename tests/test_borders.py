import itertools
import json
import logging
import unittest

import overpy
import shapely.geometry

import borders.borders
import borders.geoutils
import borders.wikidata
import converters.feature
from borders.geoutils import split_intersec
from converters.kmlshapely import kml_to_shapely
from converters.overpyshapely import OverToShape

logging.basicConfig(level=logging.DEBUG)


class BorderTests(unittest.TestCase):
    def test_process(self):
        # res = overpy.Overpass().query("[out:json];relation(3094349);out;>;out;")#.get_relation(3094349)
        with open("example.json") as f:
            res = overpy.Result.from_json(json.load(f))
        with open("example.wikidata") as f:
            wikidata = borders.wikidata.from_json(f.read())
        with open("example.kml") as f:
            obj = kml_to_shapely(f.read())
            ret = borders.borders.process(OverToShape(res).get_relation_feature().geometry, obj, wikidata=wikidata)
        with open("../out.osm", "wb+") as f:
            f.write(ret)
        rv = overpy.Result.from_xml(ret.decode('utf-8'))
        self.assertTrue(any(len([y for y in x.members if y.role == 'outer']) > 1 for x in rv.relations))
        self.assertTrue(all(('wikidata' in rel.tags) for rel in rv.relations), "Wikidata tag is on all relations")
        self.assertEqual(len(rv.get_relation_ids()), 4)

    def test_verify_no_cache_poison(self):
        # res = overpy.Overpass().query("[out:json];relation(3094349);out;>;out;")#.get_relation(3094349)
        with open("example.json") as f:
            res = overpy.Result.from_json(json.load(f))
        with open("example.kml") as f:
            obj = kml_to_shapely(f.read())
            ret = borders.borders.process(OverToShape(res).get_relation_feature().geometry, obj)
        with open("../out.osm", "wb+") as f:
            f.write(ret)

        with open("example.kml") as f:
            obj = kml_to_shapely(f.read())
            ret2 = borders.borders.process(OverToShape(res).get_relation_feature().geometry, obj)
        self.assertEqual(ret, ret2)

    def test_no_overlapping_ways(self):
        # res = overpy.Overpass().query("[out:json];relation(3094349);out;>;out;")#.get_relation(3094349)
        with open("example.json") as f:
            adm_boundary = overpy.Result.from_json(json.load(f))
        with open("test_overlapping_ways.kml") as part1, open("2010042_part_2.kml") as part2:
            obj = kml_to_shapely(part1.read())
            # obj.extend(kml_to_shapely(part2.read()))
            self.assertEqual(len(obj), 3)
            ret = borders.borders.process(OverToShape(adm_boundary).get_relation_feature().geometry, obj)
        with open("../out.osm", "wb+") as f:
            f.write(ret)

        rv = overpy.Result.from_xml(ret.decode('utf-8'))
        inner_nodes = sorted(list(x.id for x in itertools.chain(*(way.nodes[1:-1] for way in rv.get_ways()))))
        dup_nodes = [x[0] for x in itertools.groupby(inner_nodes) if len(list(x[1])) > 1]
        self.assertEqual(len(dup_nodes), 0, "Duplicate nodes found: {0}".format(len(dup_nodes)))

    def test_no_overlapping_ways_big(self):
        # res = overpy.Overpass().query("[out:json];relation(3094349);out;>;out;")#.get_relation(3094349)
        with open("example.json") as f:
            adm_boundary = overpy.Result.from_json(json.load(f))
        with open("2010042_part_1.kml") as part1, open("2010042_part_2.kml") as part2:
            obj = kml_to_shapely(part1.read())
            obj.extend(kml_to_shapely(part2.read()))
            ret = borders.borders.process(OverToShape(adm_boundary).get_relation_feature().geometry, obj)
        with open("../out.osm", "wb+") as f:
            f.write(ret)

        rv = overpy.Result.from_xml(ret.decode('utf-8'))
        inner_nodes = sorted(list(x.id for x in itertools.chain(*(way.nodes[1:-1] for way in rv.get_ways()))))
        dup_nodes = [x[0] for x in itertools.groupby(inner_nodes) if len(list(x[1])) > 1]
        # allow for one dup node - actually it's ok for this data set
        self.assertTrue(len(dup_nodes) <= 1, "Duplicate nodes found: {0}".format(len(dup_nodes)))


    def test_split_extra_point(self):
        # 2 boxes exactly the same with extra point along the line
        border1 = converters.feature.Feature(
            shapely.geometry.LineString(
                [
                    (0, 0),
                    (0, 2),
                    (2, 2),
                    (2, 0),
                    (0, 0)
                ]
            )
        )
        border2 = converters.feature.Feature(
            shapely.geometry.LineString(
                [
                    (0, 1),
                    (0, 2),
                    (2, 2),
                    (2, 0),
                    (0, 0),
                    (0, 1)
                ]
            )
        )
        rv = borders.borders.split_by_common_ways([border1, border2])
        self.assertEqual(len(rv[0].geometry.geoms), 1)

    def test_split_same_geo(self):
        # 2 boxes exactly the same
        border1 = converters.feature.Feature(
            shapely.geometry.LineString(
                [
                    (0, 0),
                    (0, 2),
                    (2, 2),
                    (2, 0),
                    (0, 0)
                ]
            )
        )
        border2 = converters.feature.Feature(
            shapely.geometry.LineString(
                [
                    (0, 0),
                    (0, 2),
                    (2, 2),
                    (2, 0),
                    (0, 0),
                ]
            )
        )
        rv = borders.borders.split_by_common_ways([border1, border2])
        self.assertEqual(len(rv[0].geometry.geoms), 1)

    def test_split_one_line(self):
        # two boxes - left and right
        # (0,1)---(1,1)---(2,1)
        #   |       |       |
        # (0,0)---(1,0)---(2,0)
        # 2 small one
        left = converters.feature.Feature(
            shapely.geometry.LineString(
                [
                    (0, 0),
                    (0, 1),
                    (1, 1),
                    (1, 0),
                    (0, 0)
                ]
            )
        )
        right = converters.feature.Feature(
            shapely.geometry.LineString(
                [
                    (1, 1),
                    (1, 0),
                    (2, 0),
                    (2, 1),
                    (1, 1),
                ]
            )
        )
        rv = borders.borders.split_by_common_ways([left, right])
        self.assertEqual(len(rv[0].geometry.geoms), 3)
        self.assertEqual(len(rv[1].geometry.geoms), 2)
        geoms = list(rv[0].geometry.geoms)
        self.assertTrue(shapely.geometry.LineString([(1, 1), (1, 0)]) in geoms)

    def test_3_geo_line_and_outline(self):
        # three boxes:
        # (0,2)---(1,2)
        #   |       |
        # (0,1)---(1,1)
        #   |       |
        # (0,0)---(1,0)
        # 2 small one - bottom and upper, and one outline
        bottom = converters.feature.Feature(
            shapely.geometry.LinearRing(
                [
                    (0, 0),
                    (0, 1),
                    (1, 1),
                    (1, 0),
                ]
            ))

        upper = converters.feature.Feature(
            shapely.geometry.LinearRing(
                [
                    (0, 1),
                    (1, 1),
                    (1, 2),
                    (0, 2),

                ]
            ))

        outline = converters.feature.Feature(
            shapely.geometry.LinearRing(
                [
                    (0, 0),
                    (0, 2),
                    (1, 2),
                    (1, 0),
                ]
            ))

        rv = borders.borders.split_by_common_ways([bottom, upper, outline])

        self.assertEqual(len(rv[0].geometry.geoms), 3)
        self.assertTrue(
            (shapely.geometry.LineString([(0, 1), (1, 1)]) in list(rv[0].geometry.geoms)) or (
                shapely.geometry.LineString([(1, 1), (0, 1)]) in list(rv[0].geometry.geoms)
            )
        )
        self.assertEqual(len(rv[1].geometry.geoms), 2)
        self.assertTrue(shapely.geometry.LineString([(0, 1), (1, 1)]) in list(rv[1].geometry.geoms))
        self.assertEqual(len(rv[2].geometry.geoms), 3)
        self.assertTrue(shapely.geometry.LineString([(1, 1), (1, 2), (0, 2), (0, 1)]) in list(rv[2].geometry.geoms))
        self.assertTrue(shapely.geometry.LineString([(1, 1), (1, 0), (0, 0)]) in list(rv[2].geometry.geoms))

    def test_3_geo_line_and_outline_reversed(self):
        # three boxes:
        # (0,2)---(1,2)
        #   |       |
        # (0,1)---(1,1)
        #   |       |
        # (0,0)---(1,0)
        # 2 small one - bottom and upper, and one outline
        bottom = converters.feature.Feature(
            shapely.geometry.LinearRing(
                [
                    (0, 0),
                    (0, 1),
                    (1, 1),
                    (1, 0),
                ]
            ))

        upper = converters.feature.Feature(
            shapely.geometry.LinearRing(
                reversed([
                    (0, 1),
                    (1, 1),
                    (1, 2),
                    (0, 2),

                ])
            ))

        outline = converters.feature.Feature(
            shapely.geometry.LinearRing(
                [
                    (0, 0),
                    (1, 0),
                    (1, 2),
                    (0, 2),
                ]
            ))

        rv = borders.borders.split_by_common_ways([bottom, upper, outline])

        self.assertEqual(len(rv[0].geometry.geoms), 3)
        self.assertTrue(
            shapely.geometry.LineString([(0, 1), (1, 1)]) in list(rv[0].geometry.geoms)
        )
        self.assertEqual(len(rv[1].geometry.geoms), 3)
        self.assertTrue(shapely.geometry.LineString([(0, 1), (1, 1)]) in list(rv[1].geometry.geoms))
        self.assertEqual(len(rv[2].geometry.geoms), 4)
        self.assertTrue(shapely.geometry.LineString([(0, 1), (0, 2)]) in list(rv[2].geometry.geoms))
        self.assertTrue(shapely.geometry.LineString([(1, 1), (1, 0), (0, 0)]) in list(rv[2].geometry.geoms))

    @unittest.skip("Desn't work yet")
    def test_split_extra_line(self):
        # 2 boxes exactly the same with extra point along the line
        border1 = converters.feature.Feature(
            shapely.geometry.MultiLineString([
                [
                    (0, 0),
                    (0, 2),
                    (2, 2),
                ], [
                    (2, 2),
                    (2, 0),
                    (0, 0)
                ]
            ])
        )
        border2 = converters.feature.Feature(
            shapely.geometry.LineString(
                [
                    (0, 1),
                    (0, 2),
                    (2, 2),
                    (2, 0),
                    (0, 0),
                    (0, 1)
                ]
            )
        )
        rv = borders.borders.split_by_common_ways([border1, border2])
        self.assertEqual(len(rv[0].geometry.geoms), 2)

    def test_split_one_common_edge(self):
        # 2 boxes exactly the same with extra point along the line
        border1 = converters.feature.Feature(
            shapely.geometry.LineString(
                [
                    (0, 0),
                    (0, 2),
                ]
            )
        )
        border2 = converters.feature.Feature(
            shapely.geometry.LineString(
                [
                    (0, 0),
                    (0, 2),
                    (2, 2),
                    (2, 0),
                    (0, 0),
                ]
            )
        )
        rv = borders.borders.split_by_common_ways([border1, border2])
        self.assertEqual(len(rv[1].geometry.geoms), 2)

    def test_lines_shared_by_3(self):
        # three boxes:
        # (0,2)---(1,2)---(2,2)
        #   |       |       |
        # (0,1)---(1,1)     |
        #   |       |       |
        # (0,0)---(1,0)----(2,0)
        # 2 small one - bottom and upper, and one outline
        bottom = converters.feature.Feature(
            shapely.geometry.LinearRing(
                [
                    (0, 0),
                    (0, 1),
                    (1, 1),
                    (1, 0),
                ]
            ))

        upper = converters.feature.Feature(
            shapely.geometry.LinearRing(
                reversed([
                    (0, 1),
                    (1, 1),
                    (1, 2),
                    (0, 2),

                ])
            ))

        right = converters.feature.Feature(
            shapely.geometry.LinearRing(
                [
                    (1, 0),
                    (2, 0),
                    (2, 2),
                    (1, 2),
                ]
            ))

        rv = borders.borders.split_by_common_ways([bottom, upper, right])

        self.assertEqual(len(rv[0].geometry.geoms), 4)
        self.assertTrue(
            shapely.geometry.LineString([(0, 1), (1, 1)]) in list(rv[0].geometry.geoms)
        )
        self.assertTrue(
            shapely.geometry.LineString([(1, 1), (1, 0)]) in list(rv[0].geometry.geoms)
        )

        self.assertEqual(len(rv[1].geometry.geoms), 4)
        self.assertTrue(shapely.geometry.LineString([(0, 1), (1, 1)]) in list(rv[1].geometry.geoms))
        self.assertTrue(shapely.geometry.LineString([(1, 2), (1, 1)]) in list(rv[1].geometry.geoms))
        self.assertEqual(len(rv[2].geometry.geoms), 3)
        self.assertTrue(shapely.geometry.LineString([(1, 2), (1, 1)]) in list(rv[2].geometry.geoms))
        self.assertTrue(shapely.geometry.LineString([(1, 1), (1, 0)]) in list(rv[2].geometry.geoms))

    @unittest.skip("Test fails, although usually it works ok")
    def test_create_multi_string(self):
        other_geo = shapely.geometry.asShape({"type": "MultiLineString", "coordinates": [
            [[22.76047092, 52.61546139], [22.76064297, 52.61612468], [22.76105567, 52.61771505],
             [22.76108073, 52.61783719], [22.76108384, 52.6178525], [22.76139736, 52.61938449],
             [22.76244925, 52.61976631], [22.76268426, 52.62022516], [22.76264229, 52.62045121],
             [22.76251974, 52.62111035], [22.76245299, 52.62147661], [22.76236904, 52.62193968],
             [22.76232238, 52.62219597], [22.76227375, 52.62235994], [22.76217722, 52.62268248],
             [22.7620684, 52.62304795], [22.76186122, 52.62317808], [22.76159148, 52.62334756],
             [22.76137031, 52.62348662], [22.76090434, 52.62373826], [22.76064532, 52.62387845],
             [22.76008432, 52.62403247], [22.75894507, 52.62430293], [22.75882211, 52.62433202],
             [22.75862406, 52.62437911], [22.75785951, 52.62461745], [22.75717809, 52.62482996],
             [22.75711238, 52.6248503], [22.75691077, 52.62491325], [22.75632337, 52.62509655],
             [22.75618569, 52.62528501], [22.75590341, 52.62573943], [22.75583175, 52.62585498],
             [22.75570535, 52.62592699], [22.75561602, 52.62597818], [22.75556603, 52.62600668]],
            [[22.75925843, 52.61034505], [22.75973145, 52.61195017], [22.75988232, 52.61253082],
             [22.759887, 52.6125484], [22.75989522, 52.61258129], [22.75990058, 52.61260076], [22.7599031, 52.61261058],
             [22.76003255, 52.6131086], [22.76005563, 52.61323251], [22.76016858, 52.61383874],
             [22.76047092, 52.61546139]],
            [[22.72576493, 52.63109363], [22.72101464, 52.62983602], [22.72103002, 52.62981515],
             [22.72131641, 52.62942593], [22.72143714, 52.62926195], [22.72146099, 52.62922914],
             [22.72151835, 52.6291512], [22.72153358, 52.62913061], [22.72158187, 52.62906507],
             [22.72164523, 52.62897893], [22.72170875, 52.6288928], [22.72179319, 52.62877794],
             [22.72187748, 52.62866309], [22.72200435, 52.62849091], [22.72203895, 52.62844392],
             [22.72207386, 52.62839648], [22.72214293, 52.62830223], [22.72231209, 52.62807253],
             [22.72236638, 52.62799878], [22.72249618, 52.62782232], [22.72256509, 52.62772842],
             [22.72262598, 52.62764603], [22.72269504, 52.62755178], [22.72274624, 52.62748267],
             [22.7227647, 52.62745735], [22.72283421, 52.6273631], [22.72290311, 52.62726911],
             [22.7229514, 52.62720348], [22.72299369, 52.62714606], [22.72303598, 52.62708863],
             [22.72309334, 52.62701079], [22.72314302, 52.62694311], [22.7231627, 52.62691636],
             [22.72322606, 52.62683031], [22.72328927, 52.62674417], [22.72331924, 52.62670387],
             [22.72336492, 52.62664163], [22.72344658, 52.62653061], [22.72359913, 52.62632329],
             [22.72363373, 52.6262763], [22.72409245, 52.62565282], [22.72410383, 52.6256373],
             [22.72414012, 52.62558799], [22.72434033, 52.62531584], [22.72447826, 52.62512841],
             [22.72454039, 52.62504387], [22.72455761, 52.62502051], [22.72474735, 52.6247629],
             [22.72496523, 52.62446712], [22.72514281, 52.62422637], [22.7253035, 52.62400781],
             [22.72543926, 52.62382367], [22.72588237, 52.62322213], [22.72609532, 52.62293259],
             [22.72621631, 52.62276861], [22.72656334, 52.62231181], [22.72684035, 52.6219471],
             [22.72738528, 52.62122972], [22.72754728, 52.6210163], [22.72864445, 52.61957198],
             [22.72954448, 52.61972167], [22.73064326, 52.61998447], [22.73215682, 52.61806204],
             [22.73222718, 52.61797264], [22.73225203, 52.61794073], [22.73225616, 52.61793548],
             [22.73228102, 52.61790303], [22.73231219, 52.61786193], [22.73216854, 52.6178097],
             [22.73100139, 52.61738494], [22.73069583, 52.61727381], [22.73010433, 52.61692513],
             [22.73009184, 52.61691772], [22.72942935, 52.61652711], [22.73197264, 52.61384718],
             [22.73255974, 52.61328409], [22.73283424, 52.61292087], [22.73285281, 52.61289635],
             [22.73337307, 52.61220798], [22.73374827, 52.61151643], [22.73388815, 52.61127903],
             [22.73393916, 52.61119959], [22.73407844, 52.61098313], [22.73437007, 52.61036771],
             [22.73404209, 52.60938185], [22.73392481, 52.60903052], [22.73350555, 52.60777064],
             [22.73349438, 52.60773799], [22.73334522, 52.60728961], [22.7344778, 52.60694347],
             [22.73465652, 52.60688957], [22.73588683, 52.6065378], [22.73633532, 52.60641002],
             [22.73673446, 52.60629906], [22.73709713, 52.6061984], [22.73718835, 52.60617303],
             [22.73801434, 52.60594205], [22.73841825, 52.60582906], [22.73854563, 52.60579402],
             [22.7392066, 52.60561285], [22.73922921, 52.60560662], [22.7394579, 52.60554443],
             [22.7396244, 52.60549911], [22.73991781, 52.60541937], [22.74019238, 52.60529125],
             [22.74032466, 52.60522938], [22.74081219, 52.60500062], [22.74157158, 52.60465538],
             [22.74169633, 52.60459864], [22.74183738, 52.60453426], [22.74224484, 52.60434841],
             [22.74294525, 52.60403076], [22.74328812, 52.60387307], [22.74337698, 52.60383204],
             [22.74417268, 52.603558], [22.74444148, 52.60346549], [22.74468271, 52.6033823],
             [22.74622063, 52.60285475], [22.74630173, 52.60282685], [22.7467573, 52.60267097],
             [22.74727817, 52.6024925], [22.74744396, 52.60243521], [22.74799512, 52.60224483],
             [22.74895135, 52.60191457], [22.74943184, 52.6017487], [22.75034621, 52.60143596],
             [22.75157606, 52.60099685], [22.75176441, 52.60092963], [22.75249538, 52.60061261],
             [22.75332682, 52.60020919], [22.75334198, 52.60021061], [22.75328828, 52.60133782],
             [22.75327185, 52.60168232], [22.75327034, 52.60170945], [22.75327009, 52.60171825],
             [22.75325825, 52.60191703], [22.75324916, 52.60207592], [22.75324536, 52.60213682],
             [22.7532399, 52.60223042], [22.75323901, 52.60224613], [22.75323021, 52.60240018],
             [22.75322605, 52.60246853], [22.75318684, 52.60313716], [22.75322709, 52.60332076],
             [22.75329186, 52.60361839], [22.75334057, 52.60384234], [22.75334946, 52.60388252],
             [22.75336759, 52.60396665], [22.75340364, 52.60413196], [22.75342423, 52.60434284],
             [22.753432, 52.60442265], [22.75347485, 52.60486322], [22.75348926, 52.60501068],
             [22.75352326, 52.60535761], [22.75355167, 52.60565144], [22.75356001, 52.60573727],
             [22.75356608, 52.60579908], [22.75358222, 52.60595357], [22.75359428, 52.60606955],
             [22.75361218, 52.606245], [22.75362136, 52.60633237], [22.75363411, 52.60645527],
             [22.75364685, 52.60657854], [22.75365623, 52.60666914], [22.75368496, 52.6069468],
             [22.75368984, 52.6069935], [22.7538572, 52.60712028], [22.75395244, 52.60719238],
             [22.75404783, 52.60726456], [22.75428327, 52.60744284], [22.75436384, 52.60751163],
             [22.75469882, 52.607798], [22.75504994, 52.60809828], [22.75533289, 52.60834033],
             [22.75538939, 52.60838864], [22.7555053, 52.60846104], [22.75570274, 52.60858427],
             [22.75597954, 52.60875705], [22.75617683, 52.60888027], [22.75702336, 52.60927752],
             [22.75726962, 52.60933502], [22.75737743, 52.60936014], [22.75832595, 52.60958184],
             [22.75876948, 52.60968544], [22.75887259, 52.60982449], [22.75925843, 52.61034505]],
            [[22.75556603, 52.62600668], [22.75546505, 52.62594253], [22.75534349, 52.62586486],
             [22.75524599, 52.62580281], [22.75517374, 52.62575693], [22.7551382, 52.62573418],
             [22.75507842, 52.62569643], [22.75501458, 52.6256563], [22.75493013, 52.62560293],
             [22.75480492, 52.62552396], [22.75452299, 52.62534627], [22.75427546, 52.62519016],
             [22.75420505, 52.62513145], [22.75384206, 52.62482852], [22.75331633, 52.62474354],
             [22.75261638, 52.62463048], [22.75240306, 52.62459597], [22.75214784, 52.62455481],
             [22.75179838, 52.62449828], [22.75159982, 52.62446932], [22.75129655, 52.62442496],
             [22.75100415, 52.62438224], [22.75066308, 52.62433236], [22.75044217, 52.6243001],
             [22.75023214, 52.62426939], [22.74999976, 52.62423539], [22.7498048, 52.62420979],
             [22.74969239, 52.62419485], [22.74955996, 52.62417736], [22.74955246, 52.62417629],
             [22.74954775, 52.62417571], [22.74945093, 52.62416309], [22.74925701, 52.6241374],
             [22.74908427, 52.62411464], [22.74898157, 52.62410097], [22.74887254, 52.62408661],
             [22.74875395, 52.62407089], [22.74862771, 52.62405418], [22.74857901, 52.62404783],
             [22.74851263, 52.62403445], [22.7484138, 52.62401472], [22.74840543, 52.6240131],
             [22.74824272, 52.62398064], [22.74821966, 52.62397608], [22.74821129, 52.62397438],
             [22.74803375, 52.62393889], [22.74781744, 52.62389553], [22.74743753, 52.62381961],
             [22.74724384, 52.62378089], [22.74705572, 52.62374331], [22.74688641, 52.62378682],
             [22.74674998, 52.62382178], [22.74660848, 52.62385821], [22.74645628, 52.62389722],
             [22.74628519, 52.62394116], [22.74603256, 52.62400589], [22.74579436, 52.62406709],
             [22.74574883, 52.62407353], [22.74550013, 52.62410936], [22.74527353, 52.62414201],
             [22.74494979, 52.62418856], [22.74481706, 52.62420755], [22.74471533, 52.6242222],
             [22.74441309, 52.62426565], [22.74436692, 52.62427414], [22.74412893, 52.62431737],
             [22.74392198, 52.6243549], [22.74367493, 52.62439982], [22.74355141, 52.62442224],
             [22.74340087, 52.62444959], [22.74328685, 52.6244704], [22.74323999, 52.62448194],
             [22.74309437, 52.62451788], [22.74299382, 52.62454269], [22.74290249, 52.62456545],
             [22.74279539, 52.62459191], [22.74260708, 52.62463853], [22.74246562, 52.62467343],
             [22.74237682, 52.6246955], [22.74228355, 52.6247185], [22.74214849, 52.62475185],
             [22.74207084, 52.62477116], [22.74204705, 52.62477702], [22.74201596, 52.62478478],
             [22.74190188, 52.62484324], [22.74182049, 52.62488516], [22.7408833, 52.62541779],
             [22.74026866, 52.6256674], [22.74005422, 52.62575437], [22.73975549, 52.62587567],
             [22.73935756, 52.62588743], [22.7390016, 52.62589794], [22.73864624, 52.62590844],
             [22.73828393, 52.62591905], [22.73764534, 52.62593796], [22.73755044, 52.62594063],
             [22.73634886, 52.62585079], [22.73587519, 52.62581545], [22.73580032, 52.62580989],
             [22.73564099, 52.62581367], [22.73496748, 52.62582958], [22.73490748, 52.62583101],
             [22.7348992, 52.62583128], [22.7342551, 52.6258466], [22.73410269, 52.62586645],
             [22.73375252, 52.62591214], [22.73340115, 52.62595799], [22.73294527, 52.62601747],
             [22.73291989, 52.62602151], [22.73255074, 52.62607994], [22.73194893, 52.62617515],
             [22.73120796, 52.62654685], [22.73106318, 52.62661954], [22.7305061, 52.62689902],
             [22.72937027, 52.62775622], [22.72826782, 52.62806175], [22.72807097, 52.62811625],
             [22.726655, 52.62834299], [22.72609278, 52.62960115], [22.72583574, 52.63111227],
             [22.72576493, 52.63109363]]]})
        intersec = shapely.geometry.asShape({"type": "LineString",
                                             "coordinates": [[22.75925843, 52.61034505], [22.75973145, 52.61195017],
                                                             [22.75988232, 52.61253082], [22.759887, 52.6125484],
                                                             [22.75989522, 52.61258129], [22.75990058, 52.61260076],
                                                             [22.7599031, 52.61261058], [22.76003255, 52.6131086],
                                                             [22.76005563, 52.61323251], [22.76016858, 52.61383874],
                                                             [22.76047092, 52.61546139], [22.76064297, 52.61612468],
                                                             [22.76105567, 52.61771505], [22.76108073, 52.61783719],
                                                             [22.76108384, 52.6178525], [22.76139736, 52.61938449],
                                                             [22.76244925, 52.61976631], [22.76268426, 52.62022516],
                                                             [22.76264229, 52.62045121], [22.76251974, 52.62111035],
                                                             [22.76245299, 52.62147661], [22.76236904, 52.62193968],
                                                             [22.76232238, 52.62219597], [22.76227375, 52.62235994],
                                                             [22.76217722, 52.62268248], [22.7620684, 52.62304795],
                                                             [22.76186122, 52.62317808], [22.76159148, 52.62334756],
                                                             [22.76137031, 52.62348662], [22.76090434, 52.62373826],
                                                             [22.76064532, 52.62387845], [22.76008432, 52.62403247],
                                                             [22.75894507, 52.62430293], [22.75882211, 52.62433202],
                                                             [22.75862406, 52.62437911], [22.75785951, 52.62461745],
                                                             [22.75717809, 52.62482996], [22.75711238, 52.6248503],
                                                             [22.75691077, 52.62491325], [22.75632337, 52.62509655],
                                                             [22.75618569, 52.62528501], [22.75590341, 52.62573943],
                                                             [22.75583175, 52.62585498], [22.75570535, 52.62592699],
                                                             [22.75561602, 52.62597818], [22.75556603, 52.62600668]]})

        self.assertTrue(len(other_geo) == len(other_geo.difference(shapely.geometry.LineString())))
        rv = borders.geoutils.create_multi_string(intersec, other_geo.difference(intersec))
        for i in other_geo.geoms:
            print(json.dumps(shapely.geometry.mapping(i)))
        print("---")

        for i in rv.geoms:
            print(json.dumps(shapely.geometry.mapping(i)))
        self.assertTrue(len(other_geo) <= len(rv))

    def test_split_intersec(self):
        intersec = shapely.geometry.asShape({"coordinates": [[22.70529538, 52.60739471], [22.70482792, 52.6073213],
                                                             [22.70411021, 52.60720856], [22.70391975, 52.6071787],
                                                             [22.70331805, 52.60713706], [22.70306301, 52.60711953],
                                                             [22.70282917, 52.60709441], [22.70269789, 52.6070803],
                                                             [22.70255411, 52.60706497], [22.70228833, 52.60703636],
                                                             [22.70201106, 52.60700672], [22.7018267, 52.6069709],
                                                             [22.70176269, 52.60695852], [22.7012297, 52.60685507],
                                                             [22.70069626, 52.6067517], [22.69930014, 52.60612269],
                                                             [22.69925935, 52.60610436], [22.6991552, 52.6061167],
                                                             [22.69912942, 52.60611974], [22.69841608, 52.60620421],
                                                             [22.69754932, 52.60621472], [22.69706257, 52.60628477],
                                                             [22.69547437, 52.60651293], [22.69510972, 52.60650298],
                                                             [22.6948976, 52.60649704], [22.69443692, 52.60648442],
                                                             [22.69440875, 52.60648357], [22.69377815, 52.6064661],
                                                             [22.69310653, 52.60644754], [22.6927008, 52.60641422],
                                                             [22.69188434, 52.60634687], [22.69118997, 52.60628968],
                                                             [22.69075664, 52.60625595], [22.69053115, 52.60623827],
                                                             [22.69048871, 52.60627501], [22.6901082, 52.60657917],
                                                             [22.68872931, 52.60768153], [22.68867576, 52.60772444],
                                                             [22.68766431, 52.60853436], [22.68682557, 52.60920579],
                                                             [22.68607846, 52.60980409], [22.68577507, 52.6101978],
                                                             [22.68483203, 52.61142117], [22.68436003, 52.61199151],
                                                             [22.68431913, 52.61204066], [22.68352018, 52.61300579],
                                                             [22.68350026, 52.61303019], [22.68323352, 52.61295874],
                                                             [22.68302963, 52.61290417], [22.68239495, 52.61245374]],
                                             "type": "LineString"})
        border = shapely.geometry.asShape({"coordinates": [
            [[22.67814111, 52.59716707], [22.678432, 52.59717301], [22.67888053, 52.59727185],
             [22.67982961, 52.59761048], [22.68017137, 52.59770156], [22.68059526, 52.59778592],
             [22.68115301, 52.59798384], [22.68207949, 52.59819602], [22.68248434, 52.59829526],
             [22.68313054, 52.59835961], [22.68334458, 52.59838401], [22.68354789, 52.59838195],
             [22.68385926, 52.59842891], [22.68436865, 52.59845336], [22.68471209, 52.59847919],
             [22.68492548, 52.59849522], [22.6855025, 52.59853857], [22.68618644, 52.59859002],
             [22.68643357, 52.59860858], [22.6874212, 52.59882544], [22.68760406, 52.59886575],
             [22.68776713, 52.59890162], [22.68792881, 52.5989098], [22.68923002, 52.59924902],
             [22.68929352, 52.59927246], [22.68968363, 52.59941663], [22.68981889, 52.59948428],
             [22.68993393, 52.59954172], [22.69027965, 52.59971434], [22.69046468, 52.59976123],
             [22.69081921, 52.59985098], [22.69123609, 52.60009772], [22.69129353, 52.6001317],
             [22.69182755, 52.6003409], [22.69249635, 52.60045569], [22.69279976, 52.60050785],
             [22.69320506, 52.60053398], [22.69348845, 52.60060442], [22.69349959, 52.60060706],
             [22.69364626, 52.60064355], [22.69378708, 52.60067845], [22.69390709, 52.60070818],
             [22.69397735, 52.60073313], [22.69455316, 52.60093757], [22.69476233, 52.60101186],
             [22.69497442, 52.60108727], [22.69499802, 52.60104322], [22.69508707, 52.6010567],
             [22.69533338, 52.60109356], [22.69571458, 52.60115097], [22.69602304, 52.60119742],
             [22.69612871, 52.60121332], [22.69631358, 52.60124106], [22.69642497, 52.60125793],
             [22.6965127, 52.60127111], [22.69664589, 52.60127474], [22.69672126, 52.60127691],
             [22.69800003, 52.60131219], [22.69827538, 52.6013651], [22.6988829, 52.60148161],
             [22.69929638, 52.60156093], [22.70012174, 52.6017439], [22.70061623, 52.60181952],
             [22.70113556, 52.60189892], [22.70263174, 52.60201041]],
            [[22.67604779, 52.60313097], [22.67620185, 52.60272672], [22.67645994, 52.60234277],
             [22.67647849, 52.60231502], [22.67651665, 52.60221479], [22.67656455, 52.60208985],
             [22.67669564, 52.60174709], [22.67677017, 52.60163485], [22.67741394, 52.60066391],
             [22.67762863, 52.60046075], [22.67792173, 52.60018325], [22.6780837, 52.60003002],
             [22.67837205, 52.59986112], [22.67904404, 52.59912254], [22.6776347, 52.59835265],
             [22.67773628, 52.59824908], [22.67776232, 52.59822223], [22.67776073, 52.59815759],
             [22.67805311, 52.59776126], [22.67788831, 52.59764599], [22.67814111, 52.59716707]],
            [[22.70263174, 52.60201041], [22.70313699, 52.60223686], [22.7031804, 52.60225639],
             [22.70477178, 52.60296981], [22.70478139, 52.60297414], [22.7052039, 52.60316364],
             [22.70559451, 52.60333877], [22.70588721, 52.60347004], [22.70639016, 52.60369528],
             [22.70732015, 52.6041124], [22.70854477, 52.60466125], [22.70807158, 52.60505928],
             [22.70759807, 52.60545784], [22.70705069, 52.60591833], [22.7053794, 52.607324],
             [22.70529538, 52.60739471], [22.70482792, 52.6073213], [22.70411021, 52.60720856],
             [22.70391975, 52.6071787], [22.70331805, 52.60713706], [22.70306301, 52.60711953],
             [22.70282917, 52.60709441], [22.70269789, 52.6070803], [22.70255411, 52.60706497],
             [22.70228833, 52.60703636], [22.70201106, 52.60700672], [22.7018267, 52.6069709],
             [22.70176269, 52.60695852], [22.7012297, 52.60685507], [22.70069626, 52.6067517],
             [22.69930014, 52.60612269], [22.69925935, 52.60610436], [22.6991552, 52.6061167],
             [22.69912942, 52.60611974], [22.69841608, 52.60620421], [22.69754932, 52.60621472],
             [22.69706257, 52.60628477], [22.69547437, 52.60651293], [22.69510972, 52.60650298],
             [22.6948976, 52.60649704], [22.69443692, 52.60648442], [22.69440875, 52.60648357],
             [22.69377815, 52.6064661], [22.69310653, 52.60644754], [22.6927008, 52.60641422],
             [22.69188434, 52.60634687], [22.69118997, 52.60628968], [22.69075664, 52.60625595],
             [22.69053115, 52.60623827], [22.69048871, 52.60627501], [22.6901082, 52.60657917],
             [22.68872931, 52.60768153], [22.68867576, 52.60772444], [22.68766431, 52.60853436],
             [22.68682557, 52.60920579], [22.68607846, 52.60980409], [22.68577507, 52.6101978],
             [22.68483203, 52.61142117], [22.68436003, 52.61199151], [22.68431913, 52.61204066],
             [22.68352018, 52.61300579], [22.68350026, 52.61303019], [22.68323352, 52.61295874],
             [22.68302963, 52.61290417], [22.68239495, 52.61245374], [22.68249155, 52.6123298],
             [22.68198398, 52.61165915], [22.68103933, 52.61113327], [22.68071391, 52.61099079],
             [22.67996553, 52.61089626], [22.67949089, 52.610674], [22.67931773, 52.61066326],
             [22.67908311, 52.61064887], [22.67840501, 52.61061821], [22.67729213, 52.61045408],
             [22.67679075, 52.61038008], [22.67613684, 52.61010557], [22.67615673, 52.61007757],
             [22.67616628, 52.61006428], [22.67629623, 52.60988256], [22.67631195, 52.60986072],
             [22.67635449, 52.60980134], [22.67662736, 52.60913435], [22.67663843, 52.60903642],
             [22.67671566, 52.60835044], [22.67674358, 52.60774767], [22.67677634, 52.60703782],
             [22.67670962, 52.60697407], [22.67678828, 52.60658803], [22.67683747, 52.60549001],
             [22.6767295, 52.60541825], [22.67669356, 52.60497484], [22.67668344, 52.60485015],
             [22.67661623, 52.6047633], [22.67647827, 52.60369851], [22.67607387, 52.60367125],
             [22.67591179, 52.60348959], [22.67604779, 52.60313097]]], "type": "MultiLineString"})
        other = shapely.geometry.asShape({"coordinates": [[22.71007285, 52.61632616], [22.70847411, 52.61760477],
                                                          [22.70631048, 52.61932702], [22.70469095, 52.61908643],
                                                          [22.70443306, 52.61904811], [22.70277415, 52.61880166],
                                                          [22.70269872, 52.61879041], [22.70108701, 52.61855129],
                                                          [22.70045172, 52.61845696], [22.69952399, 52.61831924],
                                                          [22.69997544, 52.6179548], [22.69966347, 52.61782339],
                                                          [22.69940852, 52.61771607], [22.69932802, 52.61768211],
                                                          [22.69886232, 52.61748601], [22.69846183, 52.6173174],
                                                          [22.69843923, 52.61730772], [22.6979642, 52.61710782],
                                                          [22.69752974, 52.61692473], [22.69745565, 52.61689362],
                                                          [22.69738317, 52.61618145], [22.69772561, 52.6159074],
                                                          [22.69781471, 52.61583585], [22.69753299, 52.61578539],
                                                          [22.69719736, 52.61572544], [22.69701011, 52.61566612],
                                                          [22.69645101, 52.61548903], [22.69618799, 52.6154056],
                                                          [22.69591546, 52.61531938], [22.69565766, 52.61526917],
                                                          [22.69497792, 52.61513702], [22.69464113, 52.61507148],
                                                          [22.69455877, 52.61505547], [22.69446527, 52.61504186],
                                                          [22.69427001, 52.61501355], [22.69411784, 52.61499147],
                                                          [22.69393833, 52.6149654], [22.69346903, 52.61489723],
                                                          [22.69335979, 52.61488137], [22.69327634, 52.61489204],
                                                          [22.69318548, 52.61490362], [22.6929824, 52.61492978],
                                                          [22.69273472, 52.61496138], [22.69228485, 52.61501906],
                                                          [22.69213425, 52.61503843], [22.69165845, 52.61509933],
                                                          [22.69123247, 52.61525218], [22.69122386, 52.6152634],
                                                          [22.6906903, 52.61596844], [22.69066539, 52.61600142],
                                                          [22.69065248, 52.61601826], [22.69015103, 52.61664114],
                                                          [22.69011414, 52.6166898], [22.68811669, 52.61607154],
                                                          [22.68767706, 52.61661573], [22.68714097, 52.6172792],
                                                          [22.68628399, 52.61833699], [22.68676334, 52.61848449],
                                                          [22.68692152, 52.61853316], [22.6860108, 52.61892373],
                                                          [22.68529857, 52.61922914], [22.68426565, 52.61961134],
                                                          [22.68288837, 52.61967692], [22.68121139, 52.61956784],
                                                          [22.68074314, 52.61953746], [22.68002285, 52.61969715],
                                                          [22.67952793, 52.61980704], [22.67854551, 52.62014759],
                                                          [22.67719939, 52.62061431], [22.6756337, 52.62115711],
                                                          [22.67596539, 52.62068258], [22.67632918, 52.62016194],
                                                          [22.67657133, 52.61981556], [22.6767959, 52.61949406],
                                                          [22.6769703, 52.61924427], [22.67725837, 52.61886856],
                                                          [22.67762345, 52.61839224], [22.67794547, 52.61797234],
                                                          [22.67833566, 52.61746619], [22.67856685, 52.61713451],
                                                          [22.67931628, 52.6160594], [22.67943434, 52.61589013],
                                                          [22.67953282, 52.61576782], [22.67963805, 52.61563697],
                                                          [22.68014017, 52.61514887], [22.68098543, 52.61416963],
                                                          [22.68156778, 52.61351641], [22.68159957, 52.61347543],
                                                          [22.68239495, 52.61245374], [22.68302963, 52.61290417],
                                                          [22.68323352, 52.61295874], [22.68350026, 52.61303019],
                                                          [22.68352018, 52.61300579], [22.68431913, 52.61204066],
                                                          [22.68436003, 52.61199151], [22.68483203, 52.61142117],
                                                          [22.68577507, 52.6101978], [22.68607846, 52.60980409],
                                                          [22.68682557, 52.60920579], [22.68766431, 52.60853436],
                                                          [22.68867576, 52.60772444], [22.68872931, 52.60768153],
                                                          [22.6901082, 52.60657917], [22.69048871, 52.60627501],
                                                          [22.69053115, 52.60623827], [22.69075664, 52.60625595],
                                                          [22.69118997, 52.60628968], [22.69188434, 52.60634687],
                                                          [22.6927008, 52.60641422], [22.69310653, 52.60644754],
                                                          [22.69377815, 52.6064661], [22.69440875, 52.60648357],
                                                          [22.69443692, 52.60648442], [22.6948976, 52.60649704],
                                                          [22.69510972, 52.60650298], [22.69547437, 52.60651293],
                                                          [22.69706257, 52.60628477], [22.69754932, 52.60621472],
                                                          [22.69841608, 52.60620421], [22.69912942, 52.60611974],
                                                          [22.6991552, 52.6061167], [22.69925935, 52.60610436],
                                                          [22.69930014, 52.60612269], [22.70069626, 52.6067517],
                                                          [22.7012297, 52.60685507], [22.70176269, 52.60695852],
                                                          [22.7018267, 52.6069709], [22.70201106, 52.60700672],
                                                          [22.70228833, 52.60703636], [22.70255411, 52.60706497],
                                                          [22.70269789, 52.6070803], [22.70282917, 52.60709441],
                                                          [22.70306301, 52.60711953], [22.70331805, 52.60713706],
                                                          [22.70391975, 52.6071787], [22.70411021, 52.60720856],
                                                          [22.70482792, 52.6073213], [22.70529538, 52.60739471],
                                                          [22.70559252, 52.60744146], [22.70621958, 52.60753981],
                                                          [22.70645485, 52.6075768], [22.70651771, 52.6076031],
                                                          [22.70727827, 52.60792085], [22.70781354, 52.60833384],
                                                          [22.70816232, 52.60860278], [22.70824186, 52.60866414],
                                                          [22.7085149, 52.6088279], [22.708876, 52.60904449],
                                                          [22.70896072, 52.60909556], [22.70933532, 52.60932021],
                                                          [22.70950045, 52.6094836], [22.70969024, 52.60967208],
                                                          [22.70987331, 52.6098532], [22.70994346, 52.60992281],
                                                          [22.71026697, 52.61024351], [22.71040098, 52.61037583],
                                                          [22.71060041, 52.61057339], [22.71080958, 52.61078086],
                                                          [22.71146973, 52.6112829], [22.71160924, 52.61138913],
                                                          [22.71181288, 52.61154396], [22.71209724, 52.6117606],
                                                          [22.71215341, 52.61179347], [22.71265602, 52.61209005],
                                                          [22.7129704, 52.61227538], [22.71322323, 52.61242453],
                                                          [22.71350756, 52.61259228], [22.71371095, 52.61272085],
                                                          [22.7141869, 52.61302109], [22.71271939, 52.61420339],
                                                          [22.71098211, 52.61559898], [22.71015314, 52.61626215],
                                                          [22.71012653, 52.61628325], [22.71007285, 52.61632616]],
                                          "type": "LineString"})
        rv = split_intersec(intersec, [border, other])
        self.assertTrue(rv.symmetric_difference(intersec).is_empty)

    @unittest.skip("Still looking for idea how to solve this")
    def test_for_small_lines(self):
        with open("2815042.json") as f:
            res = overpy.Result.from_json(json.load(f))
        with open("2815042.kml") as f:
            obj = kml_to_shapely(f.read())
            ret = borders.borders.process(OverToShape(res).get_relation_feature().geometry, obj)
        with open("../out.osm", "wb+") as f:
            f.write(ret)
        rv = overpy.Result.from_xml(ret.decode('utf-8'))
        rel = [x for x in rv.relations if x.tags.get('name') == 'Pelnik'][0]
        self.assertLess(len(rel.members), 10) # bad: 89

    def test_gminy_prg(self):
        ret = borders.borders.gminy_prg_as_osm("0216")
        with open("../out.osm", "wb+") as f:
            f.write(ret)
        rv = overpy.Result.from_xml(ret.decode('utf-8'))
        self.assertEquals(
            {'Radwanice', 'Gaworzyce', 'Grębocice', 'Polkowice', 'Chocianów', 'Przemków'},
            set(x.tags.get('name') for x in rv.relations)
        )

    @unittest.skip("No idea how to make it work...")
    def test_overlapping_ways(self):
        with open("0402102.json") as f:
            res = overpy.Result.from_json(json.load(f))
        with open("0402102.kml") as f:
            obj = kml_to_shapely(f.read())
            ret = borders.borders.process(OverToShape(res).get_relation_feature().geometry, obj)
        with open("../out.osm", "wb+") as f:
            f.write(ret)
        rv = overpy.Result.from_xml(ret.decode('utf-8'))
        rel = [x for x in rv.relations if x.tags.get('name') == 'Tomki'][0]
        self.assertEqual(7, len(rel.members)) # bad: 46
